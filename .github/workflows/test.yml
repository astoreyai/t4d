name: Tests & Coverage

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    name: Test Suite
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      neo4j:
        image: neo4j:5.13
        env:
          NEO4J_AUTH: neo4j/testpassword
          NEO4J_apoc_import_file_enabled: "true"
          NEO4J_apoc_export_file_enabled: "true"
        options: >-
          --health-cmd "wget --no-verbose --tries=1 --spider http://localhost:7474"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 7687:7687

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -e ".[dev]"
          pip install hypothesis  # For property-based tests

      - name: Lint with ruff
        run: |
          ruff check src/ tests/ --select E,F,W --max-line-length 100
        continue-on-error: true

      - name: Type check with mypy
        run: |
          mypy src/ww --strict || true
        continue-on-error: true

      - name: Run tests with coverage
        run: |
          pytest tests/ \
            -v \
            --cov=src/ww \
            --cov-report=xml \
            --cov-report=term-missing \
            --cov-report=html \
            -m "not slow"
        env:
          NEO4J_URI: bolt://localhost:7687
          NEO4J_USER: neo4j
          NEO4J_PASSWORD: testpassword

      - name: Check coverage threshold
        run: |
          coverage report --fail-under=70
        continue-on-error: true

      - name: Generate coverage badge
        if: always()
        run: |
          coverage-badge -o coverage.svg -f

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          fail_ci_if_error: false
          verbose: true

      - name: Archive coverage reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: coverage-reports
          path: |
            htmlcov/
            coverage.xml
            coverage.svg

      - name: Comment PR with coverage
        if: github.event_name == 'pull_request' && always()
        uses: py-cov-action/python-coverage-comment-action@v3
        with:
          GITHUB_TOKEN: ${{ github.token }}

  property-tests:
    name: Property-Based Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install hypothesis

      - name: Run property-based tests
        run: |
          pytest tests/unit/test_algorithms_property.py \
            -v \
            --tb=short \
            --hypothesis-seed=42

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      neo4j:
        image: neo4j:5.13
        env:
          NEO4J_AUTH: neo4j/testpassword
        options: >-
          --health-cmd "wget --no-verbose --tries=1 --spider http://localhost:7474"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 7687:7687

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run integration tests
        run: |
          pytest tests/integration/ \
            -v \
            -m "integration" \
            --tb=short
        env:
          NEO4J_URI: bolt://localhost:7687
          NEO4J_USER: neo4j
          NEO4J_PASSWORD: testpassword

  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run security tests
        run: |
          pytest tests/security/ \
            -v \
            -m "security" \
            --tb=short

      - name: Check for hardcoded secrets
        run: |
          pip install detect-secrets
          detect-secrets scan --baseline .secrets.baseline
        continue-on-error: true

  all-checks:
    name: All Checks Complete
    needs: [test, property-tests, integration-tests, security-tests]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Decide whether all checks passed
        run: |
          if [[ "${{ needs.test.result }}" == "failure" || \
                "${{ needs.property-tests.result }}" == "failure" || \
                "${{ needs.integration-tests.result }}" == "failure" || \
                "${{ needs.security-tests.result }}" == "failure" ]]; then
            echo "One or more test jobs failed"
            exit 1
          fi
          echo "All test jobs passed!"

      - name: Create deployment annotation
        if: success() && github.ref == 'refs/heads/main'
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: context.payload.deployment.id,
              state: 'success',
              environment_url: 'https://github.com/${{ github.repository }}',
              description: 'All checks passed'
            })
