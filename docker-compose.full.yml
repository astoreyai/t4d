version: '3.8'

# T4DM Full Stack Deployment
# All storage is handled by the embedded T4DX engine (no external databases required)
#
# Quick Start:
#   1. cp .env.example .env && ./scripts/setup-env.sh
#   2. docker-compose -f docker-compose.full.yml up -d
#   3. Access API at http://localhost:8765/docs
#
# For production, set:
#   - T4DM_ENVIRONMENT=production
#   - Configure TLS certificates

services:
  # ==========================================================================
  # T4DM API Server
  # ==========================================================================

  t4dm-api:
    build:
      context: .
      dockerfile: Dockerfile
    image: t4dm:latest
    container_name: t4dm-api
    ports:
      - "${T4DM_API_PORT:-8765}:8765"
    environment:
      # Session
      - T4DM_SESSION_ID=${T4DM_SESSION_ID:-default}
      # Embedding model
      - T4DM_EMBEDDING_MODEL=${T4DM_EMBEDDING_MODEL:-BAAI/bge-m3}
      - T4DM_EMBEDDING_DIMENSION=${T4DM_EMBEDDING_DIMENSION:-1024}
      - T4DM_EMBEDDING_DEVICE=${T4DM_EMBEDDING_DEVICE:-cpu}
      - T4DM_EMBEDDING_CACHE_DIR=/app/models
      # API settings
      - T4DM_API_HOST=0.0.0.0
      - T4DM_API_PORT=8765
      - T4DM_API_WORKERS=${T4DM_API_WORKERS:-1}
      # Memory parameters
      - T4DM_FSRS_DEFAULT_STABILITY=${T4DM_FSRS_DEFAULT_STABILITY:-1.0}
      - T4DM_FSRS_RETENTION_TARGET=${T4DM_FSRS_RETENTION_TARGET:-0.9}
      - T4DM_HEBBIAN_LEARNING_RATE=${T4DM_HEBBIAN_LEARNING_RATE:-0.1}
      # T4DX storage (embedded)
      - T4DX_DATA_DIR=/app/data/t4dx
      # Observability
      - T4DM_OTEL_ENABLED=${T4DM_OTEL_ENABLED:-false}
      - T4DM_OTEL_ENDPOINT=${T4DM_OTEL_ENDPOINT:-}
    volumes:
      # Persist downloaded models
      - t4dm_models:/app/models
      # Persist T4DX data
      - t4dx_data:/app/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8765/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s  # Model loading can take time
    restart: unless-stopped
    networks:
      - t4dm-network

# ==========================================================================
# Volumes
# ==========================================================================

volumes:
  t4dm_models:
    driver: local
  t4dx_data:
    driver: local

# ==========================================================================
# Networks
# ==========================================================================

networks:
  t4dm-network:
    name: t4dm-network
