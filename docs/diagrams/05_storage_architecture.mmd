%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#f0ad4e', 'secondaryColor': '#fff8e8'}}}%%
flowchart TB
    subgraph Application["Application Layer"]
        EpisodicMem[Episodic Memory]
        SemanticMem[Semantic Memory]
        ProceduralMem[Procedural Memory]
        FastEpisodic[Fast Episodic Store]
    end

    subgraph Abstraction["Storage Abstraction"]
        QdrantStore[QdrantStore<br/>Vector Operations]
        Neo4jStore[Neo4jStore<br/>Graph Operations]
        Resilience[Resilience Layer<br/>Retry, Circuit Breaker]
        Saga[Saga Coordinator<br/>Distributed TX]
    end

    subgraph Qdrant["Qdrant Vector Database"]
        direction TB

        subgraph Collections["Collections"]
            EpisodicColl["episodic_memories<br/>Episode vectors"]
            FastColl["fast_episodic<br/>One-shot store"]
            ProceduralColl["procedural_skills<br/>Skill embeddings"]
            ClusterIdx["cluster_index<br/>Pattern clusters"]
        end

        subgraph QdrantOps["Operations"]
            Upsert[Upsert Points]
            Search[Vector Search<br/>Cosine Similarity]
            Filter[Payload Filtering]
            Scroll[Pagination/Scroll]
        end

        Collections --> QdrantOps
    end

    subgraph Neo4j["Neo4j Graph Database"]
        direction TB

        subgraph Nodes["Node Types"]
            EntityNode["(:Entity)<br/>People, Places, Things"]
            ConceptNode["(:Concept)<br/>Abstract Ideas"]
            SkillNode["(:Skill)<br/>Procedures"]
            EpisodeNode["(:Episode)<br/>Event References"]
        end

        subgraph Relations["Relationships"]
            RelatedTo["[:RELATED_TO]<br/>General relation"]
            PartOf["[:PART_OF]<br/>Composition"]
            CausedBy["[:CAUSED_BY]<br/>Causation"]
            LearnedFrom["[:LEARNED_FROM]<br/>Provenance"]
        end

        subgraph GraphOps["Operations"]
            CreateNode[Create/Merge Nodes]
            CreateRel[Create Relations]
            Traverse[Graph Traversal]
            Cypher[Cypher Queries]
        end

        Nodes --> Relations
        Relations --> GraphOps
    end

    subgraph Postgres["PostgreSQL (Optional)"]
        Sessions["sessions<br/>Session metadata"]
        Config["configuration<br/>System settings"]
        Metrics["metrics_history<br/>Historical data"]
    end

    EpisodicMem --> QdrantStore
    FastEpisodic --> QdrantStore
    ProceduralMem --> QdrantStore
    SemanticMem --> Neo4jStore

    QdrantStore --> Resilience
    Neo4jStore --> Resilience
    Resilience --> Saga

    Saga --> Qdrant
    Saga --> Neo4j
    Saga --> Postgres

    subgraph Indexes["Index Types"]
        HNSW["HNSW Index<br/>Approximate NN"]
        FullText["Full-Text Index<br/>Neo4j"]
        BTree["B-Tree Index<br/>Postgres"]
    end

    Qdrant --> HNSW
    Neo4j --> FullText
    Postgres --> BTree
