%%{init: {'theme': 'dark', 'themeVariables': { 'primaryColor': '#6366f1', 'primaryTextColor': '#e8e8f0', 'primaryBorderColor': '#818cf8', 'lineColor': '#a0a0b0', 'secondaryColor': '#1e1e2a', 'tertiaryColor': '#2a2a3a'}}}%%
sequenceDiagram
    autonumber
    participant C as Client
    participant API as API Gateway
    participant TAU as tau(t) Gate
    participant E as Embedder
    participant MI as MemoryItem
    participant T4DX as T4DX Engine
    participant WAL as Write-Ahead Log
    participant MT as MemTable
    participant SEG as Segment

    C->>+API: store_memory(content, metadata)
    API->>API: validate_input()

    API->>+TAU: should_store(content, context)
    TAU->>TAU: compute novelty score
    TAU->>TAU: compute reward signal
    TAU->>TAU: sigma(lambda_e*e + lambda_D*novelty + lambda_r*reward)
    TAU-->>-API: (should_store=true, tau=0.85)

    alt tau > threshold
        API->>+E: embed(content)
        E->>E: check_cache()
        E->>E: bge_m3_encode()
        E-->>-API: vector[1024]

        API->>+MI: create MemoryItem
        MI->>MI: set kappa=0.0 (raw episodic)
        MI->>MI: set t_ref=now(), t_sys=now()
        MI->>MI: attach embedding + metadata
        MI-->>-API: memory_item

        API->>+T4DX: insert(memory_item)

        T4DX->>+WAL: append(INSERT, item)
        WAL->>WAL: serialize JSON-line
        WAL->>WAL: fsync()
        WAL-->>-T4DX: LSN=42

        T4DX->>+MT: apply(item)
        MT->>MT: sorted insert by key

        alt MemTable full (64MB)
            MT->>+SEG: flush to segment
            SEG->>SEG: write sorted run
            SEG->>SEG: build HNSW index
            SEG->>SEG: build CSR graph
            SEG-->>-MT: segment_id
            MT->>MT: clear
        end

        MT-->>-T4DX: applied
        T4DX-->>-API: Success(LSN=42)

        API-->>C: {status: "success", memory_id, lsn: 42}
    else tau <= threshold
        API-->>C: {status: "skipped", reason: "low_salience", tau: 0.3}
    end

    Note over TAU,SEG: Compaction (NREM/REM/PRUNE) runs asynchronously
