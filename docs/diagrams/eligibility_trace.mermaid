%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#2e86ab'}}}%%
flowchart TB
    subgraph PreActivity["Pre-Memory Activity"]
        PRE_MEM["Memory A activated"]
        PRE_TRACE["Trace for Memory A<br/>e_A(t)"]
    end

    subgraph PostActivity["Post-Memory Activity"]
        POST_MEM["Memory B activated"]
        POST_TRACE["Trace for Memory B<br/>e_B(t)"]
    end

    subgraph EligibilityTrace["Eligibility Trace (per-memory-ID)"]
        direction TB
        ET["e(memory_id, t)"]
        ET_DECAY["Decay: e(t+1) = γλ × e(t)"]
        ET_PARAMS["γ = 0.99 (discount)<br/>λ = 0.9-0.95 (decay)"]
        ET_NOTE["Abstraction level: memory, not synapse"]
    end

    subgraph Neuromodulator["Neuromodulator Signal"]
        DA["Dopamine<br/>(RPE)"]
        DA_TIMING["DelayBuffer 1000ms<br/>biological arrival delay<br/>(dopamine_integration.py)"]
    end

    subgraph WeightUpdate["Weight Update"]
        DW["Δw = η × DA × e(t)"]
        RESULT["Synaptic<br/>Plasticity"]
    end

    subgraph Timeline["Temporal Dynamics"]
        T1["t=0: Memory A & B<br/>co-activated"]
        T2["t=0→τ: Eligibility<br/>trace decays"]
        T3["t=τ: DA arrives<br/>triggers update"]
    end

    %% Connections
    PRE_MEM --> PRE_TRACE
    POST_MEM --> POST_TRACE
    PRE_TRACE --> ET
    POST_TRACE --> ET
    ET --> ET_DECAY
    ET_PARAMS -.-> ET_DECAY
    ET_NOTE -.-> ET

    DA --> DA_TIMING
    DA_TIMING --> DW
    ET_DECAY --> DW
    DW --> RESULT

    T1 --> T2 --> T3

    %% Styling
    style ET fill:#e3f2fd,stroke:#1976d2
    style DA fill:#ffecb3,stroke:#ff8f00
    style DW fill:#c8e6c9,stroke:#388e3c
    style RESULT fill:#c8e6c9,stroke:#388e3c

    %% Notes
    classDef noteStyle fill:#f5f5f5,stroke:#9e9e9e
    class ET_PARAMS,DA_TIMING,Timeline,ET_NOTE noteStyle
