%%{init: {'theme': 'base'}}%%

flowchart TB
    START([System Start]) --> CHECK{Checkpoint<br/>exists?}

    CHECK -->|No| COLD[Cold Start]
    CHECK -->|Yes| WARM[Warm Start]

    subgraph ColdStart["Cold Start Path"]
        COLD --> SCAN_SEG[Scan segment directory]
        SCAN_SEG --> LOAD_SEG[Load segment manifests<br/>+ HNSW indices + CSR graphs]
        LOAD_SEG --> INIT_MT[Initialize empty MemTable]
        INIT_MT --> SCAN_WAL[Scan WAL from LSN=0]
        SCAN_WAL --> REPLAY_ALL[Replay all WAL entries<br/>into MemTable]
        REPLAY_ALL --> INIT_SPIKE[Initialize spiking state<br/>to defaults]
        INIT_SPIKE --> INIT_NEURO[Initialize neuromod bus<br/>to baseline levels]
        INIT_NEURO --> LOG_COLD[Log: SYSTEM_START<br/>mode=COLD]
    end

    subgraph WarmStart["Warm Start Path"]
        WARM --> FIND_CP[Find latest<br/>valid checkpoint_v3]
        FIND_CP --> VERIFY[Verify SHA-256]
        VERIFY -->|Invalid| FIND_PREV[Try previous<br/>checkpoint]
        FIND_PREV --> VERIFY
        VERIFY -->|Valid| DECOMP[Decompress gzip]
        DECOMP --> LOAD_T4DX[Restore T4DX state:<br/>MemTable snapshot +<br/>segment manifest]
        LOAD_T4DX --> LOAD_SPIKE[Restore spiking state:<br/>LIF potentials +<br/>RWKV hidden +<br/>thalamic params]
        LOAD_SPIKE --> LOAD_NEURO[Restore neuromod bus +<br/>kappa index + QLoRA]
        LOAD_NEURO --> GET_LSN[Get checkpoint flush LSN]
        GET_LSN --> FIND_WAL[Find WAL entries<br/>LSN > checkpoint_lsn]
        FIND_WAL --> REPLAY{Entries to<br/>replay?}
        REPLAY -->|Yes| APPLY[Apply WAL entry<br/>to MemTable]
        APPLY --> NEXT[Next entry]
        NEXT --> REPLAY
        REPLAY -->|No| LOG_WARM[Log: SYSTEM_START<br/>mode=WARM]
    end

    LOG_COLD --> READY([System Ready])
    LOG_WARM --> READY

    style COLD fill:#3498db,color:#fff
    style WARM fill:#27ae60,color:#fff
    style READY fill:#2ecc71,color:#fff
    style START fill:#9b59b6,color:#fff
