%%{init: {'theme': 'base'}}%%

sequenceDiagram
    participant OS as Operating System
    participant SH as ShutdownManager
    participant ENGINE as T4DX Engine
    participant OPS as In-Flight Operations
    participant MT as MemTable
    participant SEG as Segments
    participant CP as CheckpointManager
    participant WAL as Write-Ahead Log

    Note over OS,WAL: Graceful Shutdown Sequence

    OS->>SH: SIGTERM / SIGINT
    activate SH

    Note right of SH: Signal handler:<br/>- Sets flag ONLY<br/>- No async!<br/>- No logging!

    SH->>SH: Set shutdown_requested flag
    SH->>OS: Return immediately

    Note over SH: Main thread detects flag

    SH->>ENGINE: Begin shutdown
    activate ENGINE

    ENGINE->>OPS: Stop accepting new requests

    ENGINE->>OPS: Wait for in-flight ops
    activate OPS

    alt Drain succeeds (< 30s)
        OPS-->>ENGINE: All ops complete
    else Drain timeout
        OPS-->>ENGINE: Timeout after 30s
        Note right of ENGINE: Log warning:<br/>N ops abandoned
    end
    deactivate OPS

    ENGINE->>MT: Flush MemTable to segment
    activate MT
    MT->>SEG: Write final segment
    SEG-->>MT: segment_id
    MT-->>ENGINE: MemTable flushed
    deactivate MT

    ENGINE->>CP: Create final checkpoint_v3
    activate CP
    CP->>CP: Snapshot T4DX state
    CP->>CP: Snapshot spiking state
    CP->>CP: Compress (gzip)
    CP->>CP: Write atomically
    CP-->>ENGINE: Checkpoint complete
    deactivate CP

    ENGINE->>WAL: Truncate WAL (all flushed)
    activate WAL
    WAL->>WAL: fsync()
    WAL->>WAL: Close WAL file
    WAL-->>ENGINE: WAL closed
    deactivate WAL

    ENGINE-->>SH: Shutdown complete
    deactivate ENGINE

    SH->>OS: Exit(0)
    deactivate SH

    Note over OS,WAL: Clean exit - no data loss
