%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#f3e5f5'}}}%%
flowchart TB
    subgraph SlowOscillation["Slow Oscillation (0.5-1 Hz)"]
        direction TB
        DOWN["Down State<br/>(hyperpolarization)"]
        UP["Up State<br/>(depolarization)"]
        CORTEX["Cortical Origin"]
    end

    subgraph Spindles["Sleep Spindles (12-15 Hz)"]
        direction TB
        TRN["Thalamic Reticular<br/>Nucleus"]
        TC["Thalamocortical<br/>Neurons"]
        SIGMA["Sigma Power<br/>(11-16 Hz)"]
    end

    subgraph Ripples["Sharp-Wave Ripples (150-250 Hz)"]
        direction TB
        CA3["CA3 Sharp Wave<br/>(population burst)"]
        CA1["CA1 Ripple<br/>(fast oscillation)"]
        REPLAY["Memory Replay<br/>(20x compression)"]
    end

    subgraph Nesting["Hierarchical Nesting"]
        direction TB
        SO_UP_DRIVER["SO Up-State<br/>(Common Driver)"]
        SP_TROUGH["Spindle Troughs<br/>correlate with ripples"]
        OPTIMAL["Optimal Timing<br/>for plasticity"]
        NOTE_NOCAUSE["Note: SO up-state independently drives spindles and SWRs;<br/>spindles do not trigger SWRs (Clemens 2011; Staresina 2015)"]
    end

    subgraph PlasticityWindow["Plasticity Windows"]
        LTP_WIN["LTP Window<br/>(spindle peak)"]
        LTD_WIN["LTD Window<br/>(spindle trough)"]
        REPLAY_WIN["Replay Transfer<br/>(ripple)"]
    end

    subgraph Timing["Temporal Sequence"]
        T0["t=0ms: SO Up State"]
        T1["t=200ms: Spindle onset"]
        T2["t=400ms: Spindle peak"]
        T3["t=500ms: SWR nested in spindle trough"]
        T4["t=600ms: Plasticity"]
    end

    %% Connections
    CORTEX --> DOWN
    DOWN --> UP

    %% SO up-state independently drives BOTH spindles and SWRs
    %% NO causal link from spindles to SWRs (Clemens 2011; Staresina 2015)
    UP --> TRN
    TRN --> TC
    TC --> SIGMA

    UP -->|"independent driver"| CA3
    CA3 --> CA1
    CA1 --> REPLAY

    %% SWR-Spindle temporal correlation (not causation)
    SIGMA <-.->|"temporal correlation<br/>(not causal)"| CA1

    %% SO up-state is common driver
    UP --> SO_UP_DRIVER
    SO_UP_DRIVER -->|"drives"| TRN
    SO_UP_DRIVER -->|"drives"| CA3
    SO_UP_DRIVER --> SP_TROUGH
    SO_UP_DRIVER --> OPTIMAL

    %% Plasticity
    OPTIMAL --> LTP_WIN
    OPTIMAL --> LTD_WIN
    REPLAY --> REPLAY_WIN

    %% Timing
    T0 --> T1 --> T2 --> T3 --> T4

    %% Styling
    style SlowOscillation fill:#e8eaf6,stroke:#5c6bc0
    style Spindles fill:#f3e5f5,stroke:#9c27b0
    style Ripples fill:#e1f5fe,stroke:#03a9f4
    style Nesting fill:#fff3e0,stroke:#f57c00
    style PlasticityWindow fill:#c8e6c9,stroke:#388e3c
    style UP fill:#c5e1a5,stroke:#7cb342
    style CA1 fill:#b3e5fc,stroke:#0288d1
