%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#1a1a2e', 'primaryTextColor': '#e8e8f0', 'primaryBorderColor': '#6366f1', 'lineColor': '#818cf8', 'secondaryColor': '#16213e', 'tertiaryColor': '#0f3460', 'background': '#0a0a1a', 'mainBkg': '#1a1a2e', 'nodeBorder': '#6366f1', 'clusterBkg': '#16213e', 'clusterBorder': '#4f46e5', 'titleColor': '#e8e8f0', 'edgeLabelBackground': '#1a1a2e'}}}%%

flowchart TB
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% T4DM: SPIKING TRANSFORMER WITH ADAPTIVE MEMORY
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    subgraph INPUT["1. INPUT STREAM"]
        direction LR
        TOKENS["Token Stream<br/>text / tool / sensor"]
        EVENTS["Event Stream<br/>actions / outcomes"]
    end

    subgraph ENCODER["2. ENCODER (Sparse + Temporal)"]
        direction TB
        EMB["Embedding<br/>BGE-M3 1024d"]
        T2V["Time2Vec<br/>t2v(Ï„) = sin(Ï‰Ï„+Ï†)"]
        KWTA["k-WTA Sparse<br/>8x expansion â†’ top-k"]
        VSA["VSA Binding<br/>binary symbolic code"]
        EMB --> KWTA
        T2V --> KWTA
        KWTA --> VSA
    end

    subgraph CORE["3. SPIKING TEMPORAL CORE"]
        direction TB
        subgraph SNNRWKV["Spiking RWKV Blocks (6-12 layers)"]
            direction LR
            LIF["LIF Neurons<br/>Norse GPU<br/>u(t+Î”t) = Î±u + I - Î²a"]
            ATTN["Spike Attention<br/>STDP-weighted<br/>SÂ²TDPT-inspired"]
            RWKV["Linear Recurrence<br/>O(N) streaming<br/>SpikeGPT-style"]
            LIF --> ATTN --> RWKV
        end
        subgraph OSCILLATORS["Oscillatory Scaffolding"]
            direction LR
            THETA["Î¸ 4-8Hz<br/>Hippocampal"]
            GAMMA["Î³ 30-100Hz<br/>Cortical PING"]
            DELTA["Î´ 0.5-4Hz<br/>Sleep SWO"]
            THETA ~~~ GAMMA ~~~ DELTA
        end
        subgraph HINTON["Hinton Local Learning"]
            direction LR
            FF["Forward-Forward<br/>goodness-based<br/>no backprop"]
            CAPS["Capsule Routing<br/>pose equivariance<br/>part-whole"]
            FF ~~~ CAPS
        end
        SNNRWKV --> OSCILLATORS
        SNNRWKV --> HINTON
    end

    subgraph TEMPORAL["4. TEMPORAL CONTROL (Ï„-FIRST)"]
        direction TB
        PE["Prediction Error<br/>Îµ(t) = â€–y - Å·â€–"]
        TAU["Ï„(t) = Ïƒ(Î»_ÎµÂ·Îµ + Î»_Î”Â·novelty + Î»_rÂ·reward)"]
        BOUNDARY["Event Boundary<br/>b(t) = ğŸ™[Îµ > Î¸_Îµ âˆ¨ Î”z > Î¸_Î”]"]
        PE --> TAU
        PE --> BOUNDARY
    end

    subgraph MEMORY["5. UNIFIED 4D MEMORY SUBSTRATE"]
        direction TB
        subgraph SCHEMA["MemoryItem (single canonical record)"]
            direction LR
            FIELDS["id Â· content Â· embedding<br/>event_time Â· record_time<br/>valid_from Â· valid_until<br/>Îº âˆˆ [0,1] consolidation<br/>graph_delta Â· spike_trace"]
        end
        subgraph T4DX["T4DX (Unified 4D Index)"]
            direction LR
            VIDX["4D Vector Index<br/>dÂ² = Î±Â²â€–Î”vâ€–Â² + (1-Î±)Â²|Î”t|Â²/Ï„Â²<br/>temporal HNSW"]
            TGRAPH["Temporal Graph<br/>built-in adjacency<br/>causal + temporal edges"]
            PROV["Provenance<br/>outputâ†’input backtrace<br/>EU AI Act audit"]
            VIDX ~~~ TGRAPH ~~~ PROV
        end
        subgraph QUERYPOLICIES["3 Query Policies (NOT 3 stores)"]
            direction LR
            QE["Episodic<br/>Îº < 0.3<br/>tight Î”t"]
            QS["Semantic<br/>Îº > 0.7<br/>wide Î”t"]
            QP["Procedural<br/>type=proc<br/>success-ranked"]
            QE ~~~ QS ~~~ QP
        end
        SCHEMA --> T4DX
        T4DX --> QUERYPOLICIES
    end

    subgraph LEARNING["6. THREE-FACTOR SELF-LEARNING"]
        direction TB
        subgraph ELIGIBILITY["Eligibility Traces"]
            direction LR
            FAST["Fast e<br/>Ï„=2s"]
            SLOW["Slow e<br/>Ï„=20s"]
            FAST ~~~ SLOW
        end
        subgraph NEUROMOD["Neuromodulator Orchestra (6 NT)"]
            direction LR
            DA["DA<br/>reward<br/>VTA/SNc"]
            NE["NE<br/>arousal<br/>LC"]
            ACH["ACh<br/>encoding<br/>NBM"]
            SHT["5-HT<br/>patience<br/>Raphe"]
            DA ~~~ NE ~~~ ACH ~~~ SHT
        end
        subgraph THREEFACTOR["Î”w = Î· Â· Î´(t) Â· e_ij(t)"]
            direction LR
            STDP["STDP<br/>Bi-Poo 1998<br/>A+exp(-Î”t/Ï„+)"]
            MODGATE["Î´(t) = g(Îµ, r, Ï„)"]
            STDP ~~~ MODGATE
        end
        ELIGIBILITY --> THREEFACTOR
        NEUROMOD --> THREEFACTOR
    end

    subgraph CONSOLIDATION["7. SLEEP REPLAY CONSOLIDATION"]
        direction TB
        subgraph SLEEPPHASES["Adenosine-Driven Sleep Cycle"]
            direction LR
            NREM["NREM<br/>SWR replay<br/>STDP strengthen<br/>Îº += 0.05"]
            REM["REM<br/>HDBSCAN cluster<br/>semantic abstract<br/>Îº += 0.2"]
            PRUNE["PRUNE<br/>forget low-Îº<br/>glymphatic clear"]
            NREM --> REM --> PRUNE
        end
        subgraph REPLAY["Replay Mechanism"]
            direction LR
            SWR["Sharp-Wave Ripple<br/>10x compression<br/>PE-weighted priority"]
            REINJ["Spike Reinjection<br/>z_replay â†’ LIF â†’ spikes<br/>Î±Â·z_live + (1-Î±)Â·z_replay"]
            SWR --> REINJ
        end
        SLEEPPHASES --> REPLAY
    end

    subgraph HOMEOSTASIS["8. HOMEOSTATIC STABILIZATION"]
        direction LR
        SCALE["Synaptic Scaling<br/>w â† wÂ·(r*/rÌ‚)^Î³"]
        BCM["BCM Metaplasticity<br/>sliding threshold"]
        DECORR["Decorrelation<br/>reduce interference"]
        SCALE ~~~ BCM ~~~ DECORR
    end

    subgraph OUTPUT["9. OUTPUT + API"]
        direction LR
        READOUT["Readout Layer<br/>Hopfield completion"]
        API["FastAPI REST<br/>WebSocket stream<br/>Python SDK"]
        READOUT --> API
    end

    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% SIGNAL FLOW
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    INPUT --> ENCODER
    ENCODER --> CORE
    CORE --> OUTPUT
    CORE --> TEMPORAL
    TEMPORAL -->|"Ï„(t) gates write"| MEMORY
    TEMPORAL -->|"Ï„(t) gates plasticity"| LEARNING
    TEMPORAL -->|"Ï„(t) gates replay"| CONSOLIDATION
    MEMORY -->|"C(t) = TopK(R(t))"| CORE
    LEARNING -->|"Î”w_ij"| CORE
    CONSOLIDATION -->|"spike reinjection"| CORE
    CONSOLIDATION -->|"Îº update"| MEMORY
    HOMEOSTASIS -->|"scaling + threshold"| CORE
    HOMEOSTASIS -->|"norm monitoring"| LEARNING

    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% STYLING
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    classDef inputStyle fill:#1e3a5f,stroke:#4a9eff,color:#e8e8f0,stroke-width:2px
    classDef encoderStyle fill:#2d1b4e,stroke:#a855f7,color:#e8e8f0,stroke-width:2px
    classDef coreStyle fill:#4a1942,stroke:#ec4899,color:#e8e8f0,stroke-width:2px
    classDef temporalStyle fill:#4a3000,stroke:#f59e0b,color:#e8e8f0,stroke-width:2px
    classDef memoryStyle fill:#064e3b,stroke:#10b981,color:#e8e8f0,stroke-width:2px
    classDef learnStyle fill:#7f1d1d,stroke:#ef4444,color:#e8e8f0,stroke-width:2px
    classDef consolidateStyle fill:#1e1b4b,stroke:#6366f1,color:#e8e8f0,stroke-width:2px
    classDef homeoStyle fill:#3b3100,stroke:#eab308,color:#e8e8f0,stroke-width:2px
    classDef outputStyle fill:#164e63,stroke:#06b6d4,color:#e8e8f0,stroke-width:2px

    class TOKENS,EVENTS inputStyle
    class EMB,T2V,KWTA,VSA encoderStyle
    class LIF,ATTN,RWKV,THETA,GAMMA,DELTA,FF,CAPS coreStyle
    class PE,TAU,BOUNDARY temporalStyle
    class FIELDS,VIDX,TGRAPH,PROV,QE,QS,QP memoryStyle
    class FAST,SLOW,DA,NE,ACH,SHT,STDP,MODGATE learnStyle
    class NREM,REM,PRUNE,SWR,REINJ consolidateStyle
    class SCALE,BCM,DECORR homeoStyle
    class READOUT,API outputStyle
