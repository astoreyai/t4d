direction: up

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# T4DM: SPIKING TRANSFORMER WITH ADAPTIVE 4D MEMORY
# Vaswani-style architecture diagram
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# --- INPUT ---
input: Input {
  style.fill: "#1e3a5f"
  style.stroke: "#4a9eff"
  style.font-color: "#e8e8f0"
  style.border-radius: 8

  tokens: "Token Stream\n(text / tool / sensor)" {
    shape: rectangle
    style.fill: "#1e3a5f"
    style.stroke: "#4a9eff"
    style.font-color: "#e8e8f0"
  }
  events: "Event Stream\n(actions / outcomes)" {
    shape: rectangle
    style.fill: "#1e3a5f"
    style.stroke: "#4a9eff"
    style.font-color: "#e8e8f0"
  }
}

# --- EMBEDDING ---
embed: Embedding Layer {
  style.fill: "#2d1b4e"
  style.stroke: "#a855f7"
  style.font-color: "#e8e8f0"
  style.border-radius: 8

  bge: "BGE-M3\n1024d" {
    shape: rectangle
    style.fill: "#2d1b4e"
    style.stroke: "#a855f7"
    style.font-color: "#e8e8f0"
  }
  t2v: "Time2Vec\nt2v(Ï„) = sin(Ï‰Ï„+Ï†)" {
    shape: rectangle
    style.fill: "#2d1b4e"
    style.stroke: "#a855f7"
    style.font-color: "#e8e8f0"
  }
  kwta: "k-WTA Sparse\n8Ã— expand â†’ top-k" {
    shape: rectangle
    style.fill: "#2d1b4e"
    style.stroke: "#a855f7"
    style.font-color: "#e8e8f0"
  }
  vsa: "VSA Binding\nbinary symbolic code" {
    shape: rectangle
    style.fill: "#2d1b4e"
    style.stroke: "#a855f7"
    style.font-color: "#e8e8f0"
  }

  bge -> kwta
  t2v -> kwta
  kwta -> vsa
}

# --- SPIKING CORE (Nx) ---
core: "Spiking RWKV Block Ã—N" {
  style.fill: "#4a1942"
  style.stroke: "#ec4899"
  style.font-color: "#e8e8f0"
  style.border-radius: 8

  lif: "LIF Neurons (Norse GPU)\nu(t+Î”t) = Î±u + I âˆ’ Î²a" {
    shape: rectangle
    style.fill: "#4a1942"
    style.stroke: "#ec4899"
    style.font-color: "#e8e8f0"
  }
  spike_attn: "Spike Attention\nSTDP-weighted\nSÂ²TDPT-inspired" {
    shape: rectangle
    style.fill: "#4a1942"
    style.stroke: "#ec4899"
    style.font-color: "#e8e8f0"
  }
  rwkv: "Linear Recurrence\nO(N) streaming\nSpikeGPT-style" {
    shape: rectangle
    style.fill: "#4a1942"
    style.stroke: "#ec4899"
    style.font-color: "#e8e8f0"
  }
  ff_layer: "Forward-Forward\ngoodness-based\nno backprop" {
    shape: rectangle
    style.fill: "#4a1942"
    style.stroke: "#ec4899"
    style.font-color: "#e8e8f0"
  }
  capsule: "Capsule Routing\npose equivariance\npartâ†’whole" {
    shape: rectangle
    style.fill: "#4a1942"
    style.stroke: "#ec4899"
    style.font-color: "#e8e8f0"
  }
  residual: "Add & Norm\n(spike residual)" {
    shape: rectangle
    style.fill: "#4a1942"
    style.stroke: "#ec4899"
    style.font-color: "#e8e8f0"
  }

  lif -> spike_attn
  spike_attn -> rwkv
  rwkv -> ff_layer
  ff_layer -> capsule
  capsule -> residual
}

# --- READOUT ---
readout: Output {
  style.fill: "#164e63"
  style.stroke: "#06b6d4"
  style.font-color: "#e8e8f0"
  style.border-radius: 8

  hopfield: "Hopfield Completion\nsoftmax(Î²Â·Xáµ€Â·q)Â·X" {
    shape: rectangle
    style.fill: "#164e63"
    style.stroke: "#06b6d4"
    style.font-color: "#e8e8f0"
  }
  api: "FastAPI / WebSocket\nPython SDK" {
    shape: rectangle
    style.fill: "#164e63"
    style.stroke: "#06b6d4"
    style.font-color: "#e8e8f0"
  }
  hopfield -> api
}

# --- MAIN VERTICAL FLOW ---
input -> embed: encode
embed -> core: sparse spikes
core -> readout: decoded

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SIDE MODULES (connected laterally to core)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# --- TEMPORAL CONTROL (left) ---
temporal: "Ï„(t) Temporal Control" {
  style.fill: "#4a3000"
  style.stroke: "#f59e0b"
  style.font-color: "#e8e8f0"
  style.border-radius: 8

  pe: "Prediction Error\nÎµ(t) = â€–y âˆ’ Å·â€–" {
    shape: rectangle
    style.fill: "#4a3000"
    style.stroke: "#f59e0b"
    style.font-color: "#e8e8f0"
  }
  tau: "Ï„(t) = Ïƒ(Î»ÎµÂ·Îµ + Î»Î”Â·novelty + Î»rÂ·reward)" {
    shape: rectangle
    style.fill: "#4a3000"
    style.stroke: "#f59e0b"
    style.font-color: "#e8e8f0"
  }
  boundary: "Event Boundary\nb(t) = ðŸ™[Îµ > Î¸Îµ]" {
    shape: rectangle
    style.fill: "#4a3000"
    style.stroke: "#f59e0b"
    style.font-color: "#e8e8f0"
  }
  pe -> tau
  pe -> boundary
}

# --- NEUROMODULATION (left) ---
neuromod: "Neuromodulator Orchestra" {
  style.fill: "#7f1d1d"
  style.stroke: "#ef4444"
  style.font-color: "#e8e8f0"
  style.border-radius: 8

  da: "DA (VTA/SNc)\nreward signal" {
    shape: rectangle
    style.fill: "#7f1d1d"
    style.stroke: "#ef4444"
    style.font-color: "#e8e8f0"
  }
  ne: "NE (LC)\narousal gain" {
    shape: rectangle
    style.fill: "#7f1d1d"
    style.stroke: "#ef4444"
    style.font-color: "#e8e8f0"
  }
  ach: "ACh (NBM)\nencoding depth" {
    shape: rectangle
    style.fill: "#7f1d1d"
    style.stroke: "#ef4444"
    style.font-color: "#e8e8f0"
  }
  sht: "5-HT (Raphe)\npatience/discount" {
    shape: rectangle
    style.fill: "#7f1d1d"
    style.stroke: "#ef4444"
    style.font-color: "#e8e8f0"
  }
}

# --- THREE-FACTOR LEARNING (left) ---
learning: "Three-Factor Learning" {
  style.fill: "#7f1d1d"
  style.stroke: "#ef4444"
  style.font-color: "#e8e8f0"
  style.border-radius: 8

  stdp: "STDP\nAâ‚Šexp(âˆ’Î”t/Ï„â‚Š)" {
    shape: rectangle
    style.fill: "#7f1d1d"
    style.stroke: "#ef4444"
    style.font-color: "#e8e8f0"
  }
  elig: "Eligibility Traces\nfast Ï„=2s Â· slow Ï„=20s" {
    shape: rectangle
    style.fill: "#7f1d1d"
    style.stroke: "#ef4444"
    style.font-color: "#e8e8f0"
  }
  rule: "Î”w = Î· Â· Î´(t) Â· eáµ¢â±¼(t)" {
    shape: rectangle
    style.fill: "#7f1d1d"
    style.stroke: "#ef4444"
    style.font-color: "#e8e8f0"
  }
  stdp -> elig -> rule
}

# --- 4D MEMORY (right) ---
memory: "T4DX Â· Unified 4D Memory" {
  style.fill: "#064e3b"
  style.stroke: "#10b981"
  style.font-color: "#e8e8f0"
  style.border-radius: 8

  item: "MemoryItem\nid Â· embedding Â· Îº âˆˆ [0,1]\nevent_time Â· valid_from/until\nspike_trace Â· graph_delta" {
    shape: rectangle
    style.fill: "#064e3b"
    style.stroke: "#10b981"
    style.font-color: "#e8e8f0"
  }
  idx: "4D Vector Index\ndÂ² = Î±Â²â€–Î”vâ€–Â² + (1âˆ’Î±)Â²|Î”t|Â²/Ï„Â²\ntemporal HNSW + provenance" {
    shape: cylinder
    style.fill: "#064e3b"
    style.stroke: "#10b981"
    style.font-color: "#e8e8f0"
  }
  policies: "Query Policies" {
    style.fill: "#064e3b"
    style.stroke: "#10b981"
    style.font-color: "#e8e8f0"

    ep: "Episodic Îº<0.3" {
      style.fill: "#064e3b"
      style.stroke: "#10b981"
      style.font-color: "#e8e8f0"
    }
    sem: "Semantic Îº>0.7" {
      style.fill: "#064e3b"
      style.stroke: "#10b981"
      style.font-color: "#e8e8f0"
    }
    proc: "Procedural" {
      style.fill: "#064e3b"
      style.stroke: "#10b981"
      style.font-color: "#e8e8f0"
    }
  }
  item -> idx
  idx -> policies
}

# --- OSCILLATORS (right) ---
osc: "Oscillatory Scaffold" {
  style.fill: "#1e1b4b"
  style.stroke: "#6366f1"
  style.font-color: "#e8e8f0"
  style.border-radius: 8

  theta: "Î¸ 4-8Hz\nhippocampal" {
    shape: rectangle
    style.fill: "#1e1b4b"
    style.stroke: "#6366f1"
    style.font-color: "#e8e8f0"
  }
  gamma: "Î³ 30-100Hz\ncortical PING" {
    shape: rectangle
    style.fill: "#1e1b4b"
    style.stroke: "#6366f1"
    style.font-color: "#e8e8f0"
  }
  delta: "Î´ 0.5-4Hz\nsleep SWO" {
    shape: rectangle
    style.fill: "#1e1b4b"
    style.stroke: "#6366f1"
    style.font-color: "#e8e8f0"
  }
}

# --- SLEEP CONSOLIDATION (right) ---
sleep: "Sleep Consolidation" {
  style.fill: "#1e1b4b"
  style.stroke: "#6366f1"
  style.font-color: "#e8e8f0"
  style.border-radius: 8

  nrem: "NREM\nSWR replay\nÎº += 0.05" {
    shape: rectangle
    style.fill: "#1e1b4b"
    style.stroke: "#6366f1"
    style.font-color: "#e8e8f0"
  }
  rem: "REM\nHDBSCAN cluster\nÎº += 0.2" {
    shape: rectangle
    style.fill: "#1e1b4b"
    style.stroke: "#6366f1"
    style.font-color: "#e8e8f0"
  }
  prune: "Prune\nforget low-Îº\nglymphatic" {
    shape: rectangle
    style.fill: "#1e1b4b"
    style.stroke: "#6366f1"
    style.font-color: "#e8e8f0"
  }
  nrem -> rem -> prune
}

# --- HOMEOSTASIS (bottom right) ---
homeo: "Homeostatic Stabilization" {
  style.fill: "#3b3100"
  style.stroke: "#eab308"
  style.font-color: "#e8e8f0"
  style.border-radius: 8

  scale: "Synaptic Scaling\nw â† wÂ·(r*/rÌ‚)^Î³" {
    shape: rectangle
    style.fill: "#3b3100"
    style.stroke: "#eab308"
    style.font-color: "#e8e8f0"
  }
  bcm: "BCM Metaplasticity\nsliding threshold" {
    shape: rectangle
    style.fill: "#3b3100"
    style.stroke: "#eab308"
    style.font-color: "#e8e8f0"
  }
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# LATERAL CONNECTIONS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Temporal control feeds into everything
core -> temporal: "prediction error"
temporal -> memory: "Ï„(t) gates write" {style.stroke: "#f59e0b"; style.font-color: "#f59e0b"}
temporal -> learning: "Ï„(t) gates plasticity" {style.stroke: "#f59e0b"; style.font-color: "#f59e0b"}
temporal -> sleep: "Ï„(t) gates replay" {style.stroke: "#f59e0b"; style.font-color: "#f59e0b"}

# Memory â†” Core
memory -> core: "C(t) = TopK(R(t))" {style.stroke: "#10b981"; style.font-color: "#10b981"}

# Learning â†’ Core
neuromod -> learning: "Î´(t) modulation" {style.stroke: "#ef4444"; style.font-color: "#ef4444"}
learning -> core: "Î”wáµ¢â±¼" {style.stroke: "#ef4444"; style.font-color: "#ef4444"}

# Oscillators â†’ Core
osc -> core: "phase gating" {style.stroke: "#6366f1"; style.font-color: "#6366f1"}

# Sleep â†’ Memory + Core
sleep -> memory: "Îº update" {style.stroke: "#6366f1"; style.font-color: "#6366f1"}
sleep -> core: "spike reinjection" {style.stroke: "#6366f1"; style.font-color: "#6366f1"}

# Homeostasis â†’ Core + Learning
homeo -> core: "scaling" {style.stroke: "#eab308"; style.font-color: "#eab308"}
homeo -> learning: "threshold" {style.stroke: "#eab308"; style.font-color: "#eab308"}
