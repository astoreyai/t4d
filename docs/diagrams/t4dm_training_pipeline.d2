direction: down

# ═══════════════════════════════════════════════════════════
# T4DM TRAINING PIPELINE
# Phase 1: QLoRA + STE → Phase 2: Three-Factor → Phase 3: Online
# ═══════════════════════════════════════════════════════════

style.fill: "#0d1117"

# ═══════════════════════════════════════════════════
# PHASE 1: Surrogate Gradient + QLoRA Backprop
# ═══════════════════════════════════════════════════

phase1: "Phase 1: Surrogate Gradient + QLoRA" {
  style.fill: "#1e3a5f"
  style.stroke: "#4a9eff"
  style.font-color: "#e8e8f0"
  style.border-radius: 8

  desc: "Standard backprop through frozen Qwen + QLoRA adapters\nSTE surrogate gradients through LIF spiking neurons" {
    shape: text
    style.font-color: "#a0a0b0"
  }

  loss: "Loss = CE + λ_ff·FF_goodness + λ_recon·reconstruction" {
    shape: rectangle
    style.fill: "#2a4a6f"
    style.stroke: "#70b8ff"
    style.font-color: "#e8e8f0"
    style.border-radius: 4
  }

  trainable1: "Trainable Parameters" {
    style.fill: "#2a4a6f"
    style.stroke: "#70b8ff"
    style.font-color: "#e8e8f0"
    style.border-radius: 4

    qlora: "QLoRA adapters (~15M)" {style.fill: "#3a5a7f"; style.font-color: "#e8e8f0"}
    spiking: "Spiking blocks (~50-80M)" {style.fill: "#3a5a7f"; style.font-color: "#e8e8f0"}
    proj: "Projection layers" {style.fill: "#3a5a7f"; style.font-color: "#e8e8f0"}
  }

  optimizer1: "AdamW + GradScaler (mixed precision)\nGradient accumulation (4 steps)" {
    shape: rectangle
    style.fill: "#2a4a6f"
    style.stroke: "#70b8ff"
    style.font-color: "#e8e8f0"
    style.border-radius: 4
  }

  loss -> optimizer1
}

# ═══════════════════════════════════════════════════
# PHASE 2: Three-Factor Local Learning
# ═══════════════════════════════════════════════════

phase2: "Phase 2: Three-Factor Local Learning" {
  style.fill: "#1a2e1a"
  style.stroke: "#27ae60"
  style.font-color: "#e8e8f0"
  style.border-radius: 8

  desc2: "Biologically plausible local learning rule\nOptionally freeze QLoRA, train spiking blocks only" {
    shape: text
    style.font-color: "#a0a0b0"
  }

  rule: "Δw = η · DA · eligibility_trace" {
    shape: rectangle
    style.fill: "#1f3a1f"
    style.stroke: "#2ecc71"
    style.font-color: "#e8e8f0"
    style.border-radius: 4
  }

  factors: "Three Factors" {
    style.fill: "#1f3a1f"
    style.stroke: "#2ecc71"
    style.font-color: "#e8e8f0"
    style.border-radius: 4

    f1: "① Pre-synaptic\n(spike activity)" {style.fill: "#2a4a2a"; style.font-color: "#e8e8f0"}
    f2: "② Post-synaptic\n(spike activity)" {style.fill: "#2a4a2a"; style.font-color: "#e8e8f0"}
    f3: "③ Neuromodulator\n(DA global signal)" {style.fill: "#4a1a1a"; style.stroke: "#e74c3c"; style.font-color: "#e8e8f0"}
  }

  gate: "ACh < 0.2 → suppress plasticity" {
    shape: diamond
    style.fill: "#4a3800"
    style.stroke: "#f39c12"
    style.font-color: "#e8e8f0"
  }

  eligibility: "Eligibility trace\n(decay = 0.95)" {
    shape: rectangle
    style.fill: "#1f3a1f"
    style.stroke: "#2ecc71"
    style.font-color: "#e8e8f0"
    style.border-radius: 4
  }

  factors -> rule
  gate -> rule: "gated" {style.stroke: "#f39c12"}
  rule -> eligibility: "accumulate"
}

# ═══════════════════════════════════════════════════
# PHASE 3: Online Learning from Experience
# ═══════════════════════════════════════════════════

phase3: "Phase 3: Online from Experience" {
  style.fill: "#2d1f4e"
  style.stroke: "#9b59b6"
  style.font-color: "#e8e8f0"
  style.border-radius: 8

  desc3: "Continuous learning during inference\nSleep consolidation updates stored memories" {
    shape: text
    style.font-color: "#a0a0b0"
  }

  online: "Online Updates" {
    style.fill: "#3d2f5e"
    style.stroke: "#8e44ad"
    style.font-color: "#e8e8f0"
    style.border-radius: 4

    stdp: "STDP edge weights" {style.fill: "#4d3f6e"; style.font-color: "#e8e8f0"}
    kappa: "κ consolidation" {style.fill: "#4d3f6e"; style.font-color: "#e8e8f0"}
    homeo: "Homeostatic scaling" {style.fill: "#4d3f6e"; style.font-color: "#e8e8f0"}
  }

  sleep: "Sleep Cycle" {
    style.fill: "#3d2f5e"
    style.stroke: "#8e44ad"
    style.font-color: "#e8e8f0"
    style.border-radius: 4

    nrem: "NREM replay" {style.fill: "#4d3f6e"; style.font-color: "#e8e8f0"}
    rem: "REM clustering" {style.fill: "#4d3f6e"; style.font-color: "#e8e8f0"}
    prune: "Pruning" {style.fill: "#4d3f6e"; style.font-color: "#e8e8f0"}
  }
}

# ═══════════════════════════════════════════════════
# FLOW
# ═══════════════════════════════════════════════════

phase1 -> phase2: "QLoRA converged\n→ switch to local" {style.stroke: "#6c757d"}
phase2 -> phase3: "Spiking converged\n→ deploy online" {style.stroke: "#6c757d"}
