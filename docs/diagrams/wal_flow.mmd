%%{init: {'theme': 'base'}}%%

sequenceDiagram
    participant Client
    participant PM as PersistenceManager
    participant WAL as WriteAheadLog
    participant Seg as WAL Segment
    participant State as In-Memory State

    Note over Client,State: Write Operation Flow

    Client->>PM: log(operation, data)
    activate PM

    PM->>WAL: append(operation, data)
    activate WAL

    WAL->>WAL: Serialize entry
    Note right of WAL: entry = header + payload<br/>header: magic, lsn, op, ts, len, crc

    WAL->>Seg: Write to current segment
    activate Seg

    alt Segment full (>64MB)
        WAL->>Seg: Close current segment
        WAL->>Seg: Create new segment
        Note right of Seg: segment_NNNNNNNN.wal
    end

    Seg->>Seg: fsync()
    Seg-->>WAL: LSN assigned
    deactivate Seg

    WAL-->>PM: Return LSN
    deactivate WAL

    PM->>State: Apply state change
    Note right of State: Now safe to modify<br/>in-memory state

    PM-->>Client: Success (LSN)
    deactivate PM

    Note over Client,State: Recovery uses LSN ordering
