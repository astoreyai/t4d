%%{init: {'theme': 'base'}}%%

sequenceDiagram
    participant Client
    participant ENGINE as T4DX Engine
    participant WAL as Write-Ahead Log
    participant Seg as WAL File
    participant MT as MemTable

    Note over Client,MT: T4DX Write Operation Flow

    Client->>ENGINE: insert(memory_item)
    activate ENGINE

    ENGINE->>WAL: append(INSERT, item)
    activate WAL

    WAL->>WAL: Serialize JSON-line entry
    Note right of WAL: entry = JSON object per line<br/>{op, lsn, ts, key, data, crc32}

    WAL->>Seg: Write to WAL file
    activate Seg

    Seg->>Seg: fsync()
    Seg-->>WAL: LSN assigned
    deactivate Seg

    WAL-->>ENGINE: Return LSN
    deactivate WAL

    ENGINE->>MT: Apply to MemTable
    Note right of MT: Sorted insert by key.<br/>Now safe: WAL has<br/>durable record.

    alt MemTable full (64MB or 10k items)
        ENGINE->>MT: Flush to new segment
        MT->>MT: Write sorted run + HNSW + CSR
        ENGINE->>WAL: Record FLUSH marker
        ENGINE->>WAL: Truncate entries before flush LSN
    end

    ENGINE-->>Client: Success (LSN)
    deactivate ENGINE

    Note over Client,MT: Recovery replays WAL from last flush LSN
